require 'rubygems'
require 'cucumber'
require 'cucumber/rake/task'

def options(config_file:  ENV["env"] || "default",
            page_dir:     "default",
            data_suite:   "default",
            url:          "default",
            report_file:  "./reports/index.html",
            users:        "default")

  "FIG_NEWTON_FILE=#{config_file}.yml page_dir=#{page_dir} data_suite=#{data_suite} url=#{url} --out=#{report_file} users=#{users}"
end

def create(name: , options:, profile: )
  Cucumber::Rake::Task.new(name) do |t|
    t.profile = "#{profile}"
    t.cucumber_opts = options
  end
end

namespace :test do
  namespace :functional do
    create(name: "bigweb", profile: "functional", options: options(url: "stubbed", users: "stubbed"))
    create(name: "mobile", profile: "functional", options: options(url: "stubbed", users: "stubbed", page_dir: "mobile", data_suite: "mobile"))
    create(name: "smoke", profile: "functional-smoke", options: options(url: "stubbed", users: "stubbed", page_dir: "mobile", data_suite: "mobile"))
    multitask :all => ["test:functional:bigweb", :"test:functional:mobile"]
  end
  namespace :integration do
    create(name: "bigweb", profile: "integration", options: options)
    create(name: "mobile", profile: "integration", options: options(page_dir: "mobile", data_suite: "mobile"))
    multitask :all => ["test:integration:bigweb", :"test:integration:mobile"]
  end
  multitask :all => ["test:integration:all", :"test:functional:all"]
end

task(:default => "test:all")

