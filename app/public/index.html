<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <script src="lib/angular-1.4.3.js"></script>
    <script src="lib/ui-router.js"></script>
    <script src="lib/jquery-3.1.1.min.js"></script>
    <script src="https://rawgithub.com/gsklee/ngStorage/master/ngStorage.js"></script>
</head>

<body ng-app="app">
    <div ui-view></div>

<script>
    var app = angular.module("app", ["ui.router", "ngStorage"]);

    app.run(function ($rootScope, $state, $localStorage) {
        var onLocationChange = function (event, next, current) {
            if (!$localStorage.user && next.templateUrl != 'login.html') {
                $state.go('login');
            }
            $rootScope.user = $localStorage.user;
        };
        $rootScope.$on('$locationChangeStart', onLocationChange);

    });

    app.config(["$stateProvider", "$urlRouterProvider", function ($stateProvider, $urlRouterProvider) {

        $stateProvider
                .state("login", {
                    url: "/login",
                    templateUrl: "templates/login.html",
                    controller: function ($scope, userService, $localStorage) {
                        var loginUser  = function (user) {
                                    $scope.error = null;
                                    $scope.user = user;
                                    $localStorage.user = user;
                            },
                            loginError = function (error) {
                                $scope.error = error;
                            };

                        $scope.login = function(){
                            userService.login($scope.form).then(loginUser, loginError);
                        };

                        $scope.form = {
                            username: null,
                            password: null
                        }
                    }
                }).state("dashboard", {
                    url: "/",
                    templateUrl: "templates/dashboard.html",
                    controller: function ($scope, userService) {
                    }
                })
    }]);

    app.directive("mobileOnly", function(){
        return {
            restrict: "C",
            link: function(scope, element){
                element.addClass("visible-xs visible-sm hidden-lg hidden-md");
            }
        };
    });

    app.directive("noMobile", function(){
        return {
            restrict: "C",
            link: function(scope, element){
                element.addClass("visible-lg visible-md hidden-xs hidden-sm");
            }
        };
    });

    app.service("userService", function ($http, $q) {
        var users = $http.get("server/users.json").then(function (response) {
            return response.data;
        });

        var service = {
            current: null,
            login: function (form) {
                var deferred = $q.defer();
                users.then(function (users) {
                    var found = users.filter(function (user) {
                        return form.username == user.id && form.password == user.password
                    });

                    service.current = found[0];
                    service.current ? deferred.resolve(service.current) : deferred.reject({message: "Incorrect username/password."});
                });
                return deferred.promise;
            }
        };
        return service;
    })
</script>
</body>
</html>