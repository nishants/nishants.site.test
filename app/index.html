<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <script src="lib/angular-1.4.3.js"></script>
    <script src="lib/ui-router.js"></script>
    <script src="lib/jquery-3.1.1.min.js"></script>
    <style>
        .error{
            color: red;
        }
    </style>
</head>

<body ng-app="app">
<div >
    <label ng-bind="users.current.name"></label>
    <div>
        <div id="mobile-label" class="visible-xs visible-sm hidden-lg hidden-md">Mobile</div>
        <div id="bigweb-label" class="device visible-lg visible-md hidden-xs hidden-sm">Bigweb</div>
    </div>
</div>
    <form class="form form-inline input-group">
        <input name="q" placeholder="search">
        <button name="btnG" class="btn btn-primary">Search</button>
    </form>

    <div>
        <h1>This is Integrated home</h1>

    </div>

    <div ui-view></div>

    <div  ng-hide="true">
        <div id="login-template" ng-non-bindable>
            <div ng-show="user.id">
                <label name="mobile-message" class="visible-xs visible-sm hidden-lg hidden-md">Welcome <span class="mobile-username">{{user.name}}</span> on mobile</label>
                <label name="bigweb-message" class="visible-lg visible-md hidden-xs hidden-sm">Welcome <span class="desktop-username ">{{user.name}}</span> on bigweb</label>

                <div>
                    <a class="btn btn-default" ui-sref="dashboard">dashboard</a>
                </div>
            </div>
            <form class="form-inline" role="form" ng-hide="user.id">
                <div class="form-group">
                    <label >Username</label>
                    <input name="username" type="text" ng-model="form.username" class="form-control input-lg input-search" placeholder="id">
                </div>
                <div class="form-group">
                    <label >Password</label>
                    <input name="password" type="password" ng-model="form.password" class="form-control input-lg input-search" placeholder="password">
                </div>
                <div class="form-group">
                    <button name="login-user" ng-click="login()" class="btn btn-primary">Login</button>
                </div>
                <div class="error" ng-bind="error.message"></div>
            </form>
        </div>

        <div id="dashboard-template">
            <div ng-show="users.current.id">
                <label ng-bind="users.current.name"></label>
                <div>
                    <div id="mobile-labelx" class="visible-xs visible-sm hidden-lg hidden-md">Mobile</div>
                    <div id="bigweb-labelx" class="device visible-lg visible-md hidden-xs hidden-sm">Bigweb</div>
                </div>
            </div>
        </div>
    </div>

<script>
    var app = angular.module("app", ["ui.router"]);

    app.config(["$stateProvider", "$urlRouterProvider", function ($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.when("", "/login");

        $stateProvider
                .state("login", {
                    url: "/login",
                    template: $("#login-template").html(),
                    controller: function ($scope, userService) {
                        $scope.user = {id: null, password: null};
                        var loginUser  = function (user) {
                                    $scope.error = null;
                                    $scope.user = user;
                            },
                            loginError = function (error) {
                                $scope.error = error;
                            };

                        $scope.login = function(){
                            userService.login($scope.form).then(loginUser, loginError);
                        };

                        $scope.form = {
                            username: null,
                            password: null
                        }
                    }
                }).state("dashboard", {
                    url: "/dashboard",
                    template: $("#dashboard-template").html(),
                    controller: function ($scope, userService) {
                        $scope.users = userService;
                    }
                })
    }]);

    app.service("userService", function ($http, $q) {
        var users = $http.get("server/users.json").then(function (response) {
            return response.data;
        });

        var service = {
            current: null,
            login: function (form) {
                var deferred = $q.defer();
                users.then(function (users) {
                    var found = users.filter(function (user) {
                        return form.username == user.id && form.password == user.password
                    });

                    service.current = found[0];
                    service.current ? deferred.resolve(service.current) : deferred.reject({message: "Incorrect username/password."});
                });
                return deferred.promise;
            }
        };
        return service;
    })
</script>
</body>
</html>